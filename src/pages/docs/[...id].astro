---
import { type CollectionEntry, getCollection, render } from "astro:content";
import { Image } from "astro:assets";

import DocsLayout from "@/layouts/DocsLayout.astro";
import SeoPage from "@/components/SeoPage.astro";

interface Props {
  entry: CollectionEntry<"docs">;
}

export async function getStaticPaths() {
  const docs = await getCollection("docs");
  return docs.map((entry) => ({
    params: { id: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);
---

<DocsLayout content={entry.body || ""}>
  <SeoPage
    slot="head"
    title={entry.data.title}
    description={entry.data.description}
  />
  <article class="docs-content">
    {
      entry.data.image && (
        <Image
          src={entry.data.image}
          alt={entry.data.imageAlt || ""}
          class="mb-8 h-auto w-full rounded-lg"
          loading="eager"
          fetchpriority="high"
          draggable="false"
        />
      )
    }

    <div
      class="prose mx-auto max-w-none"
      id="docs-content">
      <Content />
    </div>
  </article>
</DocsLayout>

<style>
  .docs-content {
    max-width: 100%;
  }

  :global(.prose) {
    max-width: 100%;
  }
</style>

<script>
  function highlightSearchTerm() {
    const urlParams = new URLSearchParams(window.location.search);
    const searchTerm = urlParams.get("search");

    if (!searchTerm) return;

    const docsContent = document.getElementById("docs-content");
    if (!docsContent) return;

    const contentText = docsContent.textContent || "";
    const searchTermLower = searchTerm.toLowerCase();
    const contentContainsSearchTerm = contentText.toLowerCase().includes(searchTermLower);

    if (!contentContainsSearchTerm) return;

    function escapeRegExp(string: string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function highlightTextNode(textNode: Text, searchText: string) {
      const parent = textNode.parentNode;
      if (!parent) return;

      const text = textNode.textContent || "";
      const escapedSearchText = escapeRegExp(searchText);
      const regex = new RegExp(`(${escapedSearchText})`, "gi");

      if (regex.test(text)) {
        const highlightedHTML = text.replace(regex, '<mark class="search-highlight">$1</mark>');
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = highlightedHTML;

        const fragment = document.createDocumentFragment();
        while (tempDiv.firstChild) {
          fragment.appendChild(tempDiv.firstChild);
        }
        parent.replaceChild(fragment, textNode);
      }
    }

    function walkTextNodes(node: Node) {
      if (node.nodeType === Node.TEXT_NODE) {
        highlightTextNode(node as Text, searchTerm!);
      } else {
        if (
          node.nodeType === Node.ELEMENT_NODE &&
          (node as Element).classList?.contains("search-highlight")
        ) {
          return;
        }

        const children = Array.from(node.childNodes);
        children.forEach((child) => walkTextNodes(child));
      }
    }

    walkTextNodes(docsContent);

    setTimeout(() => {
      const firstHighlight = document.querySelector(".search-highlight");
      if (firstHighlight) {
        firstHighlight.scrollIntoView({
          behavior: "smooth",
          block: "center",
        });

        setTimeout(() => {
          document.dispatchEvent(new CustomEvent("search-highlighting-complete"));
        }, 200);
      }
    }, 100);
  }

  document.addEventListener("astro:page-load", highlightSearchTerm);

  if (document.readyState !== "loading") {
    highlightSearchTerm();
  }
</script>
