---
import { Sun, Moon } from "lucide-astro";
---

<div
  id="theme-toggle"
  class="relative z-0 inline-grid grid-cols-2 gap-0.5 rounded-full bg-neutral-950/8.5 p-0.75 text-neutral-950 dark:bg-white/10 dark:text-white">
  <button
    aria-label="Light theme"
    data-theme="light"
    class="theme-button rounded-l-full p-1.5 sm:p-0">
    <Sun class="size-7" />
  </button>

  <button
    aria-label="Dark theme"
    data-theme="dark"
    class="theme-button rounded-r-full p-1.5 sm:p-0">
    <Moon class="size-7" />
  </button>
</div>

<style>
  .theme-button {
    transition:
      background-color 0.3s ease,
      outline 0.3s ease;
  }

  .theme-button.active {
    background-color: white;
  }

  :global(.dark) .theme-button.active {
    background-color: var(--active-bg-dark, #0f0f0f);
  }
</style>

<script data-astro-rerun is:inline>
  (function () {
    const theme = localStorage.getItem("currentTheme") || "system";
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;

    const isDark = theme === "dark" || (theme === "system" && prefersDark);

    if (isDark) {
      document.documentElement.classList.add("dark");
      document.documentElement.classList.remove("light");
    } else {
      document.documentElement.classList.add("light");
      document.documentElement.classList.remove("dark");
    }
  })();
</script>

<script>
  type Theme = "light" | "dark" | "system" | null;

  function getCurrentTheme(): Theme {
    return (localStorage.getItem("currentTheme") ?? "system") as Theme;
  }

  function updateTheme(theme: Theme): void {
    if (theme !== null) {
      localStorage.setItem("currentTheme", theme);
    } else {
      localStorage.removeItem("currentTheme");
    }

    applyTheme(theme);
  }

  function applyTheme(theme: Theme): void {
    const isDark =
      theme === "dark" ||
      (theme === "system" && window.matchMedia("(prefers-color-scheme: dark)").matches);

    if (isDark) {
      document.documentElement.classList.add("dark");
      document.documentElement.classList.remove("light");
    } else {
      document.documentElement.classList.add("light");
      document.documentElement.classList.remove("dark");
    }

    (window as any)._updateTheme?.(theme);
  }

  function updateActiveButton(): void {
    const buttons = document.querySelectorAll(".theme-button");
    const currentTheme = getCurrentTheme();
    buttons.forEach((b) => b.classList.remove("active"));

    let activeTheme: string;
    if (currentTheme === "system") {
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      activeTheme = prefersDark ? "dark" : "light";
    } else {
      activeTheme = currentTheme || "light";
    }

    buttons.forEach((button) => {
      const buttonTheme = button.getAttribute("data-theme");
      if (buttonTheme === activeTheme) {
        button.classList.add("active");
      }
    });
  }

  function initThemeToggle(): void {
    const buttons = document.querySelectorAll(".theme-button");
    const currentTheme = getCurrentTheme();

    buttons.forEach((button) => {
      button.addEventListener("click", () => {
        const selectedTheme = button.getAttribute("data-theme") as Theme;

        buttons.forEach((b) => b.classList.remove("active"));
        button.classList.add("active");

        updateTheme(selectedTheme);
      });
    });

    applyTheme(currentTheme);
    updateActiveButton();

    window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
      if (getCurrentTheme() === "system") {
        applyTheme("system");
        updateActiveButton();
      }
    });
  }

  document.addEventListener("astro:page-load", initThemeToggle);

  if (document.readyState !== "loading") {
    initThemeToggle();
  }
</script>
