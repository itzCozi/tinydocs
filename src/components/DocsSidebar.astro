---
import { getCollection } from "astro:content";
import { ChevronDown } from "lucide-astro";

interface DocItem {
  id: string;
  slug: string;
  data: {
    title: string;
    description: string;
    order?: number;
  };
}

interface NavSection {
  title: string;
  path: string;
  items: DocItem[];
}

const allDocs = await getCollection("docs");

// Group docs by directory
const sections = new Map<string, NavSection>();

allDocs.forEach((doc) => {
  const parts = doc.id.split("/");
  
  if (parts.length === 1) {
    // Root level doc
    if (!sections.has("")) {
      sections.set("", { title: "Overview", path: "", items: [] });
    }
    sections.get("")!.items.push(doc);
  } else {
    // Nested doc
    const sectionName = parts[0];
    if (!sections.has(sectionName)) {
      // Find the index file for this section to get its title
      const indexDoc = allDocs.find((d) => d.id === `${sectionName}/index`);
      sections.set(sectionName, {
        title: indexDoc?.data.title || sectionName,
        path: sectionName,
        items: [],
      });
    }
    sections.get(sectionName)!.items.push(doc);
  }
});

// Sort items within each section by order field, then by title
sections.forEach((section) => {
  section.items.sort((a, b) => {
    const orderA = a.data.order ?? 999;
    const orderB = b.data.order ?? 999;
    if (orderA !== orderB) return orderA - orderB;
    return a.data.title.localeCompare(b.data.title);
  });
});

// Convert to array and sort sections
const sortedSections = Array.from(sections.values()).sort((a, b) => {
  if (a.path === "") return -1; // Root section first
  if (b.path === "") return 1;
  return a.title.localeCompare(b.title);
});

const currentPath = Astro.url.pathname;
---

<aside class="docs-sidebar">
  <nav aria-label="Documentation navigation" class="space-y-4">
    {
      sortedSections.map((section) => (
        <div class="sidebar-section">
          {section.path !== "" && (
            <details class="sidebar-group" open>
              <summary class="sidebar-section-title">
                <ChevronDown class="chevron h-4 w-4" />
                <span>{section.title}</span>
              </summary>
              <ul class="sidebar-list">
                {section.items.map((item) => {
                  const itemPath = `/docs/${item.id}`;
                  const isActive = currentPath === itemPath || currentPath === itemPath + "/";
                  const isIndex = item.id.endsWith("/index");
                  
                  return (
                    <li>
                      <a
                        href={itemPath}
                        class:list={["sidebar-link", { active: isActive, index: isIndex }]}
                        aria-current={isActive ? "page" : undefined}>
                        {item.data.title}
                      </a>
                    </li>
                  );
                })}
              </ul>
            </details>
          )}
          {section.path === "" && (
            <ul class="sidebar-list">
              {section.items.map((item) => {
                const itemPath = `/docs/${item.id}`;
                const isActive = currentPath === itemPath || currentPath === itemPath + "/";
                
                return (
                  <li>
                    <a
                      href={itemPath}
                      class:list={["sidebar-link", { active: isActive }]}
                      aria-current={isActive ? "page" : undefined}>
                      {item.data.title}
                    </a>
                  </li>
                );
              })}
            </ul>
          )}
        </div>
      ))
    }
  </nav>
</aside>

<style>
  .docs-sidebar {
    position: sticky;
    top: 5rem;
    height: calc(100vh - 6rem);
    overflow-y: auto;
    padding-right: 1rem;
  }

  .sidebar-section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    font-size: 0.875rem;
    padding: 0.5rem 0;
    cursor: pointer;
    user-select: none;
    color: var(--color-text);
  }

  .dark .sidebar-section-title {
    color: var(--color-dark-text);
  }

  .sidebar-section-title:hover {
    color: var(--color-link);
  }

  .dark .sidebar-section-title:hover {
    color: var(--color-dark-link);
  }

  details.sidebar-group[open] .chevron {
    transform: rotate(0deg);
    transition: transform 0.2s ease;
  }

  details.sidebar-group:not([open]) .chevron {
    transform: rotate(-90deg);
    transition: transform 0.2s ease;
  }

  .sidebar-list {
    list-style: none;
    padding: 0;
    margin: 0;
    margin-left: 0.5rem;
  }

  .sidebar-link {
    display: block;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: var(--color-muted-text);
    text-decoration: none;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
  }

  .dark .sidebar-link {
    color: var(--color-dark-muted-text);
  }

  .sidebar-link:hover {
    background-color: rgba(0, 0, 0, 0.05);
    color: var(--color-link);
  }

  .dark .sidebar-link:hover {
    background-color: rgba(255, 255, 255, 0.05);
    color: var(--color-dark-link);
  }

  .sidebar-link.active {
    background-color: rgba(59, 130, 246, 0.1);
    color: var(--color-link);
    font-weight: 500;
  }

  .dark .sidebar-link.active {
    background-color: rgba(59, 130, 246, 0.15);
    color: var(--color-dark-link);
  }

  .sidebar-link.index {
    font-weight: 500;
  }

  /* Scrollbar styling */
  .docs-sidebar::-webkit-scrollbar {
    width: 6px;
  }

  .docs-sidebar::-webkit-scrollbar-track {
    background: transparent;
  }

  .docs-sidebar::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
  }

  .dark .docs-sidebar::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
  }

  .docs-sidebar::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.3);
  }

  .dark .docs-sidebar::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }
</style>
